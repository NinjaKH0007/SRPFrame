<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ខាងមាស៉ុមសំនេនមានព៉ោរមិនបងនាកសាងនាត់</title>
  <style>
    body {
      margin: 0; 
      background: #f0f4f8;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      color: #222;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }
    h2 {
      margin: 20px 10px 10px;
      font-weight: 600;
    }
    #upload {
      margin: 12px 0 18px;
    }
    #canvas {
      max-width: 90vw;
      width: 100%;
      max-height: 90vw;
      height: auto;
      border-radius: 20px;
      box-shadow:
        0 0 15px rgba(30, 136, 229, 0.7),
        0 0 30px rgba(30, 136, 229, 0.4);
      cursor: grab;
      touch-action: none;
      background: white;
      display: block;
      margin: 0 auto;
      border: 8px solid #1e88e5;
      animation: glow 2.5s infinite alternate;
    }
    @keyframes glow {
      0% {
        box-shadow:
          0 0 10px rgba(30,136,229,0.5),
          0 0 20px rgba(30,136,229,0.3);
      }
      100% {
        box-shadow:
          0 0 25px rgba(30,136,229,1),
          0 0 50px rgba(30,136,229,0.6);
      }
    }
    .controls {
      margin: 25px auto 30px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 16px;
      max-width: 480px;
      padding: 0 10px;
    }
    button {
      background-color: #1e88e5;
      border: none;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      padding: 12px 22px;
      transition: background-color 0.3s ease;
      flex: 1 1 120px;
      min-width: 120px;
      user-select: none;
    }
    button:hover, button:focus {
      background-color: #1565c0;
      outline: none;
    }
    #count {
      font-size: 18px;
      margin-bottom: 40px;
      font-weight: 600;
      color: #444;
    }
  </style>
</head>
<body>

  <h2>ខាងមាស៉ុមសំនេនមានព៉ោរមិនបងនាកសាងនាត់</h2>
  <input type="file" id="upload" accept="image/*" />
  <canvas id="canvas" width="1080" height="1080"></canvas>

  <div class="controls">
    <button onclick="zoomIn()">Zoom In</button>
    <button onclick="zoomOut()">Zoom Out</button>
    <button onclick="resetCanvas()">Reset</button>
    <button onclick="downloadImage()">Download</button>
    <button onclick="shareImage()">Share</button>
  </div>

  <div id="count">Downloads & Shares: 0</div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAIIfwK6Esa1f59Sd6GspYzrZK3WqB3hiI",
      authDomain: "counting-be8f3.firebaseapp.com",
      databaseURL: "https://counting-be8f3-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "counting-be8f3",
      storageBucket: "counting-be8f3.appspot.com",
      messagingSenderId: "109310986222",
      appId: "1:109310986222:web:9fe0bfc5f982b2530a30ff"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const countRef = db.ref('count');

    // Update count on page
    countRef.on('value', snapshot => {
      const count = snapshot.val() || 0;
      document.getElementById('count').innerText = `Downloads & Shares: ${count}`;
    });

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // State variables
    let uploadedImg = null;
    let scale = 1, posX = 0, posY = 0;
    let dragging = false;
    let dragStartX = 0, dragStartY = 0;

    const frame = new Image();
    frame.src = 'frame.png';

    frame.onload = () => {
      draw();
    };

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if(uploadedImg) {
        const w = uploadedImg.width * scale;
        const h = uploadedImg.height * scale;
        ctx.drawImage(uploadedImg, posX, posY, w, h);
      }
      ctx.drawImage(frame, 0, 0, canvas.width, canvas.height);
    }

    // Upload handling
    document.getElementById('upload').addEventListener('change', e => {
      const file = e.target.files[0];
      if(file) {
        const reader = new FileReader();
        reader.onload = function(evt) {
          uploadedImg = new Image();
          uploadedImg.onload = () => {
            scale = Math.min(
              canvas.width / uploadedImg.width,
              canvas.height / uploadedImg.height,
              1
            );
            // Center image
            posX = (canvas.width - uploadedImg.width * scale) / 2;
            posY = (canvas.height - uploadedImg.height * scale) / 2;
            draw();
          };
          uploadedImg.src = evt.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    // Zoom controls
    function zoomIn() {
      scale *= 1.1;
      draw();
    }
    function zoomOut() {
      scale /= 1.1;
      draw();
    }
    function resetCanvas() {
      scale = 1;
      posX = 0;
      posY = 0;
      draw();
    }

    // Drag support (mouse and touch)
    function pointerDown(e) {
      dragging = true;
      dragStartX = e.clientX || e.touches[0].clientX;
      dragStartY = e.clientY || e.touches[0].clientY;
      canvas.style.cursor = 'grabbing';
    }
    function pointerMove(e) {
      if(!dragging) return;
      e.preventDefault();
      const clientX = e.clientX || e.touches[0].clientX;
      const clientY = e.clientY || e.touches[0].clientY;
      const dx = clientX - dragStartX;
      const dy = clientY - dragStartY;
      posX += dx;
      posY += dy;
      dragStartX = clientX;
      dragStartY = clientY;
      draw();
    }
    function pointerUp() {
      dragging = false;
      canvas.style.cursor = 'grab';
    }

    canvas.addEventListener('mousedown', pointerDown);
    canvas.addEventListener('touchstart', pointerDown, {passive: false});

    canvas.addEventListener('mousemove', pointerMove);
    canvas.addEventListener('touchmove', pointerMove, {passive: false});

    canvas.addEventListener('mouseup', pointerUp);
    canvas.addEventListener('mouseleave', pointerUp);
    canvas.addEventListener('touchend', pointerUp);
    canvas.addEventListener('touchcancel', pointerUp);

    // Download image
    function downloadImage() {
      const link = document.createElement('a');
      link.download = 'photo.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
      countRef.transaction(n => (n || 0) + 1);
    }

    // Share image with native phone share
    function shareImage() {
      canvas.toBlob(blob => {
        const file = new File([blob], 'photo.png', { type: 'image/png' });
        if(navigator.canShare && navigator.canShare({ files: [file] })) {
          navigator.share({
            files: [file],
            title: 'Photo with Frame',
            text: 'Check out this framed photo!',
          }).then(() => {
            countRef.transaction(n => (n || 0) + 1);
          }).catch(console.error);
        } else {
          alert('Sharing not supported on this device/browser. Please download the image.');
        }
      });
    }

    // Responsive canvas sizing on desktop browsers (max width 1080)
    function resizeCanvas() {
      const maxWidth = 1080;
      const margin = 40;
      const width = Math.min(window.innerWidth - margin, maxWidth);
      canvas.style.width = width + 'px';
      canvas.style.height = width + 'px';
    }
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('load', () => {
      resizeCanvas();
      draw();
    });
  </script>

</body>
</html>
